"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7198],{3905:(e,n,r)=>{r.d(n,{Zo:()=>p,kt:()=>m});var t=r(7294);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function s(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},a=Object.keys(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var l=t.createContext({}),c=function(e){var n=t.useContext(l),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},p=function(e){var n=c(e.components);return t.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},f=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),f=c(r),m=o,k=f["".concat(l,".").concat(m)]||f[m]||u[m]||a;return r?t.createElement(k,i(i({ref:n},p),{},{components:r})):t.createElement(k,i({ref:n},p))}));function m(e,n){var r=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=r.length,i=new Array(a);i[0]=f;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<a;c++)i[c]=r[c];return t.createElement.apply(null,i)}return t.createElement.apply(null,r)}f.displayName="MDXCreateElement"},1072:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var t=r(7462),o=(r(7294),r(3905));const a={title:"React\u7684\u521d\u6b21\u6e32\u67d3",last_update:{date:"08/28/2025",author:"\u9ad8\u7ea2\u7fd4"}},i=void 0,s={unversionedId:"04React\u7684\u521d\u6b21\u6e32\u67d3",id:"04React\u7684\u521d\u6b21\u6e32\u67d3",title:"React\u7684\u521d\u6b21\u6e32\u67d3",description:"React \u7684\u521d\u6b21\u6e32\u67d3",source:"@site/react/04React\u7684\u521d\u6b21\u6e32\u67d3.md",sourceDirName:".",slug:"/04React\u7684\u521d\u6b21\u6e32\u67d3",permalink:"/website/react/04React\u7684\u521d\u6b21\u6e32\u67d3",draft:!1,tags:[],version:"current",frontMatter:{title:"React\u7684\u521d\u6b21\u6e32\u67d3",last_update:{date:"08/28/2025",author:"\u9ad8\u7ea2\u7fd4"}},sidebar:"tutorialSidebar",previous:{title:"\u521b\u5efa FiberRoot",permalink:"/website/react/03\u521b\u5efaFibreRoot"},next:{title:"react\u7684diff\u7b97\u6cd5",permalink:"/website/react/05React-diff"}},l={},c=[{value:"React \u7684\u521d\u6b21\u6e32\u67d3",id:"react-\u7684\u521d\u6b21\u6e32\u67d3",level:2}],p={toc:c};function u(e){let{components:n,...r}=e;return(0,o.kt)("wrapper",(0,t.Z)({},p,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"react-\u7684\u521d\u6b21\u6e32\u67d3"},"React \u7684\u521d\u6b21\u6e32\u67d3"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u901a\u8fc7 babel \u7f16\u8bd1\u5c06\u5199\u7684 html \u6807\u7b7e\u8f6c\u6362\u6210 jsx \u51fd\u6570\uff0c\u6267\u884c jsx \u51fd\u6570\u751f\u6210\u865a\u62df dom")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/ghx9908/image-hosting/master/img20240828141604.png?token=AU2NEGBPTRPKZWQAWSMSER3GZ3AOI",alt:null})),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"\u8c03\u7528 creatRoot \u65b9\u6cd5\u4f1a\u521b\u5efa\u4e00\u4e2a ReactDOMRoot \u4e00\u4e2a\u5b9e\u4f8b",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"\u5176\u4e2d\u4f1a\u521b\u5efa\u6839 fiber\uff0c\u8fdb\u884c\u4e8b\u4ef6\u673a\u5236\u7684\u7ed1\u5b9a \u521d\u59cb\u5316\u8ddf\u65b0\u961f\u5217")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-JS"},'const root = createRoot(document.getElementById("root"))\n')),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/ghx9908/image-hosting/master/img20240828141640.png?token=AU2NEGBXZQYAHECYZ2ICM4DGZ3AQS",alt:null})),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u8c03\u7528 root \u7684 render \u65b9\u6cd5\u5148\u628a element \u865a\u62df dom \u653e\u5230 HostRootFiber \u7684\u66f4\u65b0\u961f\u5217\u4e2d"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"\u8fd9\u662f\u4e00\u4e2a\u5faa\u73af\u94fe\u8868")),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/ghx9908/image-hosting/master/img20240828141715.png?token=AU2NEGDIJXIP754DS262GGTGZ3ASW",alt:null}))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u5f00\u59cb\u8c03\u5ea6\u66f4\u65b0\uff0c\u521d\u59cb\u5316\u6808\uff08\u521d\u6b21\u672a\u7a7a\uff0c\u66f4\u65b0\u7684\u65f6\u5019\u4f1a\u7ed9 fiber \u7684 update \u8d4b\u503c\uff09"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"//\u6839\u8282\u70b9\u8c03\u5ea6\u8ddf\u65b0\nscheduleUpdateOnFiber(root, current, lane, eventTime)\n\n// \u5e76\u53d1\u6e32\u67d3\nfunction renderRootConcurrent(root, lanes) {\n  //\u56e0\u4e3a\u5728\u6784\u5efafiber\u6811\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6b64\u65b9\u6cd5\u4f1a\u53cd\u590d\u8fdb\u5165\uff0c\u4f1a\u8fdb\u5165\u591a\u6b21\n  //\u53ea\u6709\u5728\u7b2c\u4e00\u6b21\u8fdb\u6765\u7684\u65f6\u5019\u4f1a\u521b\u5efa\u65b0\u7684fiber\u6811\uff0c\u6216\u8005\u8bf4\u65b0fiber\n  if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {\n    prepareFreshStack(root, lanes)\n  }\n  //\u5728\u5f53\u524d\u5206\u914d\u7684\u65f6\u95f4\u7247(5ms)\u5185\u6267\u884cfiber\u6811\u7684\u6784\u5efa\u6216\u8005\u8bf4\u6e32\u67d3\uff0c\n  // \u5f00\u59cb\u5de5\u4f5c\u5faa\u73af\n  workLoopConcurrent()\n  //\u5982\u679c workInProgress\u4e0d\u4e3anull\uff0c\u8bf4\u660efiber\u6811\u7684\u6784\u5efa\u8fd8\u6ca1\u6709\u5b8c\u6210\n  if (workInProgress !== null) {\n    return RootInProgress\n  }\n  //\u5982\u679cworkInProgress\u662fnull\u4e86\u8bf4\u660e\u6e32\u67d3\u5de5\u4f5c\u5b8c\u5168\u7ed3\u675f\u4e86\n  return workInProgressRootExitStatus\n}\n\n// \u6784\u5efaworkInProgress fiber\nfunction prepareFreshStack(root, renderLanes) {\n  workInProgress = createWorkInProgress(root.current, null)\n  workInProgressRootRenderLanes = renderLanes\n  workInProgressRoot = root\n  finishQueueingConcurrentUpdates()\n}\n\nexport function finishQueueingConcurrentUpdates() {\n  const endIndex = concurrentQueuesIndex //9 \u53ea\u662f\u4e00\u8fb9\u754c\u6761\u4ef6\n  concurrentQueuesIndex = 0\n  let i = 0\n  while (i < endIndex) {\n    const fiber = concurrentQueues[i++]\n    const queue = concurrentQueues[i++]\n    const update = concurrentQueues[i++]\n    const lane = concurrentQueues[i++]\n    if (queue !== null && update !== null) {\n      const pending = queue.pending\n      if (pending === null) {\n        update.next = update\n      } else {\n        update.next = pending.next\n        pending.next = update\n      }\n      queue.pending = update\n    }\n  }\n}\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u5f00\u59cb\u9012\u5f52\u6784\u5efa fiber \u6811\uff0c\u6267\u884c\u5de5\u4f5c\u5355\u5143"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * \u6267\u884c\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\n * @param {*} unitOfWork\n */\nfunction performUnitOfWork(unitOfWork) {\n  //\u83b7\u53d6\u65b0\u7684fiber\u5bf9\u5e94\u7684\u8001fiber\n  const current = unitOfWork.alternate\n  //\u5b8c\u6210\u5f53\u524dfiber\u7684\u5b50fiber\u94fe\u8868\u6784\u5efa\u540e\n  const next = beginWork(current, unitOfWork, workInProgressRootRenderLanes)\n  unitOfWork.memoizedProps = unitOfWork.pendingProps\n  if (next === null) {\n    //\u5982\u679c\u6ca1\u6709\u5b50\u8282\u70b9\u8868\u793a\u5f53\u524d\u7684fiber\u5df2\u7ecf\u5b8c\u6210\u4e86\n    completeUnitOfWork(unitOfWork)\n  } else {\n    //\u5982\u679c\u6709\u5b50\u8282\u70b9\uff0c\u5c31\u8ba9\u5b50\u8282\u70b9\u6210\u4e3a\u4e0b\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\n    workInProgress = next\n  }\n}\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u8c03\u7528 beginWork \u65b9\u6cd5 \uff0c\u6839\u636e\u8001 fiber \u548c\u65b0\u7684\u865a\u62df dom \u6784\u5efa\u65b0 fiber(diff \u7b97\u6cd5)"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * \u76ee\u6807\u662f\u6839\u636e\u65b0\u865a\u62dfDOM\u6784\u5efa\u65b0\u7684fiber\u5b50\u94fe\u8868\n * @param {*} current \u8001fiber\n * @param {*} workInProgress \u65b0\u7684fiber h1\n * @returns\n */\nexport function beginWork(current, workInProgress, renderLanes) {\n  //\u5728\u6784\u5efafiber\u6811\u4e4b\u540e\u6e05\u7a7alanes\n  workInProgress.lanes = 0\n  switch (workInProgress.tag) {\n    // \u56e0\u4e3a\u5728React\u91cc\u7ec4\u4ef6\u5176\u5b9e\u6709\u4e24\u79cd\uff0c\u4e00\u79cd\u662f\u51fd\u6570\u7ec4\u4ef6\uff0c\u4e00\u79cd\u662f\u7c7b\u7ec4\u4ef6\uff0c\u4f46\u662f\u5b83\u4eec\u90fd\u662f\u90fd\u662f\u51fd\u6570\n    case IndeterminateComponent:\n      return mountIndeterminateComponent(current, workInProgress, workInProgress.type, renderLanes)\n    case FunctionComponent: {\n      const Component = workInProgress.type\n      const nextProps = workInProgress.pendingProps\n      return updateFunctionComponent(current, workInProgress, Component, nextProps, renderLanes)\n    }\n    case HostRoot:\n      return updateHostRoot(current, workInProgress, renderLanes)\n    case HostComponent:\n      return updateHostComponent(current, workInProgress, renderLanes)\n    case HostText:\n      return null\n    default:\n      return null\n  }\n}\n\n/**\n * \u6784\u5efa\u539f\u751f\u7ec4\u4ef6\u7684\u5b50fiber\u94fe\u8868\n * @param {*} current \u8001fiber\n * @param {*} workInProgress \u65b0fiber h1\n */\nfunction updateHostComponent(current, workInProgress) {\n  const { type } = workInProgress\n  const nextProps = workInProgress.pendingProps\n  let nextChildren = nextProps.children\n  //\u5224\u65ad\u5f53\u524d\u865a\u62dfDOM\u5b83\u7684\u513f\u5b50\u662f\u4e0d\u662f\u4e00\u4e2a\u6587\u672c\u72ec\u751f\u5b50\n  const isDirectTextChild = shouldSetTextContent(type, nextProps)\n  if (isDirectTextChild) {\n    nextChildren = null\n  }\n  reconcileChildren(current, workInProgress, nextChildren)\n  return workInProgress.child\n}\n")),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u5e76\u53d1\u6784\u5efa fiber \u6811")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u521b\u5efa\u4e00\u4e2a root.current \u5bf9\u5e94\u7684 workInProgress"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"workInProgress = createWorkInProgress(root.current, null)\n")))),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/ghx9908/image-hosting/master/img20240828141930.png?token=AU2NEGBWOQRXOMZ6BS3VHD3GZ3A3G",alt:null})),(0,o.kt)("ol",{parentName:"li",start:3},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u9012\u5f52\u6784\u5efa\u5b50\u8282\u70b9 workLoopSync() \u6267\u884c\u5de5\u4f5c\u5355\u5143 \u4e00\u4e2a fiber \u5c31\u662f\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress)\n  }\n}\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"reconcileChildren \u534f\u8c03\u5b50\u8282\u70b9 diff \u7b97\u6cd5\uff0c\u6839\u636e \u8001 fiber \u548c\u65b0\u7684\u865a\u62df dom \u534f\u8c03\uff0c\u5c3d\u53ef\u80fd\u670d\u7528\u8001 fiber\uff0c")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u6839\u636e\u865a\u62df DOM \u521b\u5efa\u65b0\u7684 Fiber \u8282\u70b9,\u5e76\u4e14\u8ba9\u65b0\u521b\u5efa\u7684 fiber \u7684 return \u6307\u5411\u7236 fiber\uff0c\u7ed9 fiber \u4e0a\u9762\u6dfb\u52a0\u526f\u4f5c\u7528 Placement")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u8fd4\u56de\u65b0\u521b\u5efa\u7684\u7b2c\u4e00\u4e2a\u5b50 fiber\uff0c\u8d4b\u7ed9 workInProgress\uff0c\u9012\u5f52\u6267\u884c")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"\u6ca1\u6709\u5b50 fiber \u6267\u884c\u8be5 fiber \u7684\u5b8c\u6210\u9636\u6bb5\u4efb\u52a1")))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"completeUnitOfWork(unitOfWork)\u5b8c\u6210\u5de5\u4f5c\u5355\u5143"),(0,o.kt)("blockquote",{parentName:"li"},(0,o.kt)("p",{parentName:"blockquote"},"\u6267\u884c\u4e00\u4e2a fiber \u7684\u5b8c\u6210\u5de5\u4f5c,\u5982\u679c\u662f\u539f\u751f\u7ec4\u4ef6\u7684\u8bdd\u5c31\u662f\u521b\u5efa\u771f\u5b9e\u7684 DOM \u8282\u70b9"),(0,o.kt)("p",{parentName:"blockquote"},"\u7ed9 fiber.stateNode, fiber.fibersubtreeFlags fiber.flags \u8d4b\u503c \u6807\u8bb0\u526f\u4f5c\u7528")),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function completeUnitOfWork(unitOfWork) {\n  let completedWork = unitOfWork\n  do {\n    const current = completedWork.alternate\n    const returnFiber = completedWork.return\n    //\u6267\u884c\u6b64fiber \u7684\u5b8c\u6210\u5de5\u4f5c,\u5982\u679c\u662f\u539f\u751f\u7ec4\u4ef6\u7684\u8bdd\u5c31\u662f\u521b\u5efa\u771f\u5b9e\u7684DOM\u8282\u70b9\n    completeWork(current, completedWork)\n    //\u5982\u679c\u6709\u5f1f\u5f1f\uff0c\u5c31\u6784\u5efa\u5f1f\u5f1f\u5bf9\u5e94\u7684fiber\u5b50\u94fe\u8868\n    const siblingFiber = completedWork.sibling\n    if (siblingFiber !== null) {\n      workInProgress = siblingFiber\n      return\n    }\n    //\u5982\u679c\u6ca1\u6709\u5f1f\u5f1f\uff0c\u8bf4\u660e\u8fd9\u5f53\u524d\u5b8c\u6210\u7684\u5c31\u662f\u7236fiber\u7684\u6700\u540e\u4e00\u4e2a\u8282\u70b9\n    //\u4e5f\u5c31\u662f\u8bf4\u4e00\u4e2a\u7236fiber,\u6240\u6709\u7684\u5b50fiber\u5168\u90e8\u5b8c\u6210\u4e86\n    completedWork = returnFiber\n    workInProgress = completedWork\n  } while (completedWork !== null)\n  //\u5982\u679c\u8d70\u5230\u4e86\u8fd9\u91cc\uff0c\u8bf4\u660e\u6574\u4e2afiber\u6811\u5168\u90e8\u6784\u5efa\u5b8c\u6bd5,\u628a\u6784\u5efa\u72b6\u6001\u8bbe\u7f6e\u4e3a\u7a7a\u6210\n  if (workInProgressRootExitStatus === RootInProgress) {\n    workInProgressRootExitStatus = RootCompleted\n  }\n}\n\n/**\n * \u5b8c\u6210\u4e00\u4e2afiber\u8282\u70b9\n * @param {*} current \u8001fiber\n * @param {*} workInProgress \u65b0\u7684\u6784\u5efa\u7684fiber\n */\nexport function completeWork(current, workInProgress) {\n  const newProps = workInProgress.pendingProps\n  switch (workInProgress.tag) {\n    case HostRoot:\n      bubbleProperties(workInProgress)\n      break\n    //\u5982\u679c\u5b8c\u6210\u7684\u662f\u539f\u751f\u8282\u70b9\u7684\u8bdd\n    case HostComponent:\n      ///\u73b0\u5728\u53ea\u662f\u5728\u5904\u7406\u521b\u5efa\u6216\u8005\u8bf4\u6302\u8f7d\u65b0\u8282\u70b9\u7684\u903b\u8f91\uff0c\u540e\u9762\u6b64\u5904\u5206\u8fdb\u884c\u533a\u5206\u662f\u521d\u6b21\u6302\u8f7d\u8fd8\u662f\u66f4\u65b0\n      //\u521b\u5efa\u771f\u5b9e\u7684DOM\u8282\u70b9\n      const { type } = workInProgress\n      //\u5982\u679c\u8001fiber\u5b58\u5728\uff0c\u5e76\u4e14\u8001fiber\u4e0a\u771f\u5b9eDOM\u8282\u70b9\uff0c\u8981\u8d70\u8282\u70b9\u66f4\u65b0\u7684\u903b\u8f91\n      if (current !== null && workInProgress.stateNode !== null) {\n        updateHostComponent(current, workInProgress, type, newProps)\n        if ((current.ref !== workInProgress.ref) !== null) {\n          markRef(workInProgress)\n        }\n      } else {\n        const instance = createInstance(type, newProps, workInProgress)\n        //\u628a\u81ea\u5df1\u6240\u6709\u7684\u513f\u5b50\u90fd\u6dfb\u52a0\u5230\u81ea\u5df1\u7684\u8eab\u4e0a\n        appendAllChildren(instance, workInProgress)\n        workInProgress.stateNode = instance\n        finalizeInitialChildren(instance, type, newProps)\n        if (workInProgress.ref !== null) {\n          markRef(workInProgress)\n        }\n      }\n      bubbleProperties(workInProgress)\n      break\n    case FunctionComponent:\n      bubbleProperties(workInProgress)\n      break\n    case HostText:\n      //\u5982\u679c\u5b8c\u6210\u7684fiber\u662f\u6587\u672c\u8282\u70b9\uff0c\u90a3\u5c31\u521b\u5efa\u771f\u5b9e\u7684\u6587\u672c\u8282\u70b9\n      const newText = newProps\n      //\u521b\u5efa\u771f\u5b9e\u7684DOM\u8282\u70b9\u5e76\u4f20\u5165stateNode\n      workInProgress.stateNode = createTextInstance(newText)\n      //\u5411\u4e0a\u5192\u6ce1\u5c5e\u6027\n      bubbleProperties(workInProgress)\n      break\n  }\n}\n\nexport function createInstance(type, props, internalInstanceHandle) {\n  const domElement = document.createElement(type)\n  //\u9884\u5148\u7f13\u5b58fiber\u8282\u70b9\u5230DOM\u5143\u7d20\u4e0a\n  precacheFiberNode(internalInstanceHandle, domElement)\n  //\u628a\u5c5e\u6027\u76f4\u63a5\u4fdd\u5b58\u5728domElement\u7684\u5c5e\u6027\u4e0a\n  updateFiberProps(domElement, props)\n\n  return domElement\n}\n")),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/ghx9908/image-hosting/master/img20240828141900.png?token=AU2NEGG3X2COZLV43K7XAGTGZ3AZM",alt:null}))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"fiber \u6811\u90fd\u6784\u5efa\u5b8c\u6210 \u8fdb\u5165\u4f53\u68c0\u9636\u6bb5")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"commitRoot(root) \u5f00\u59cb\u8fdb\u5165\u63d0\u4ea4 \u9636\u6bb5\uff0c\u5c31\u662f\u6267\u884c\u526f\u4f5c\u7528\uff0c\u4fee\u6539\u771f\u5b9e DOM"),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"\u5148\u770b\u6709\u6ca1\u6709\u9700\u8981\u5220\u9664\u7684\uff0c\u9012\u5f52\u5220\u9664\u5b50 fiber \uff0c\u8981\u6267\u884c\u526f\u4f5c\u7528"),(0,o.kt)("li",{parentName:"ol"},"\u63d2\u5165\u6216\u8005\u79fb\u52a8\uff0c\u9700\u8981\u627e\u5230\u6700\u8fd1\u7684\u4e0d\u9700\u8981\u79fb\u52a8\u7684\u771f\u5b9e\u5f1f\u5f1f\uff0c\u8fdb\u884c\u63d2\u5165")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * \u904d\u5386fiber\u6811\uff0c\u6267\u884cfiber\u4e0a\u7684\u526f\u4f5c\u7528\n * @param {*} finishedWork fiber\u8282\u70b9\n * @param {*} root \u6839\u8282\u70b9\n */\nexport function commitMutationEffectsOnFiber(finishedWork, root) {\n  const current = finishedWork.alternate\n  const flags = finishedWork.flags\n  switch (finishedWork.tag) {\n    case FunctionComponent: {\n      //\u5148\u904d\u5386\u5b83\u4eec\u7684\u5b50\u8282\u70b9\uff0c\u5904\u7406\u5b83\u4eec\u7684\u5b50\u8282\u70b9\u4e0a\u7684\u526f\u4f5c\u7528\n      recursivelyTraverseMutationEffects(root, finishedWork)\n      //\u518d\u5904\u7406\u81ea\u5df1\u8eab\u4e0a\u7684\u526f\u4f5c\u7528\n      commitReconciliationEffects(finishedWork)\n      if (flags & Update) {\n        commitHookEffectListUnmount(HookHasEffect | HookLayout, finishedWork)\n      }\n      break\n    }\n    case HostRoot:\n    case HostText: {\n      //\u5148\u904d\u5386\u5b83\u4eec\u7684\u5b50\u8282\u70b9\uff0c\u5904\u7406\u5b83\u4eec\u7684\u5b50\u8282\u70b9\u4e0a\u7684\u526f\u4f5c\u7528\n      recursivelyTraverseMutationEffects(root, finishedWork)\n      //\u518d\u5904\u7406\u81ea\u5df1\u8eab\u4e0a\u7684\u526f\u4f5c\u7528\n      commitReconciliationEffects(finishedWork)\n      break\n    }\n    case HostComponent: {\n      //\u5148\u904d\u5386\u5b83\u4eec\u7684\u5b50\u8282\u70b9\uff0c\u5904\u7406\u5b83\u4eec\u7684\u5b50\u8282\u70b9\u4e0a\u7684\u526f\u4f5c\u7528\n      recursivelyTraverseMutationEffects(root, finishedWork)\n      //\u518d\u5904\u7406\u81ea\u5df1\u8eab\u4e0a\u7684\u526f\u4f5c\u7528\n      commitReconciliationEffects(finishedWork)\n      if (flags & Ref) {\n        commitAttachRef(finishedWork)\n      }\n      //\u5904\u7406DOM\u66f4\u65b0\n      if (flags & Update) {\n        //\u83b7\u53d6\u771f\u5b9eDOM\n        const instance = finishedWork.stateNode\n        //\u66f4\u65b0\u771f\u5b9eDOM\n        if (instance !== null) {\n          const newProps = finishedWork.memoizedProps\n          const oldProps = current !== null ? current.memoizedProps : newProps\n          const type = finishedWork.type\n          const updatePayload = finishedWork.updateQueue\n          finishedWork.updateQueue = null\n          if (updatePayload) {\n            commitUpdate(instance, updatePayload, type, oldProps, newProps, finishedWork)\n          }\n        }\n      }\n      break\n    }\n    default:\n      break\n  }\n}\n\n/**\n * \u9012\u5f52\u904d\u5386\u5904\u7406\u53d8\u66f4\u7684\u4f5c\u7528\n * @param {*} root \u6839\u8282\u70b9\n * @param {*} parentFiber \u7236fiber\n */\nfunction recursivelyTraverseMutationEffects(root, parentFiber) {\n  //\u5148\u628a\u7236fiber\u4e0a\u8be5\u5220\u9664\u7684\u8282\u70b9\u90fd\u5220\u9664\n  const deletions = parentFiber.deletions\n  if (deletions !== null) {\n    for (let i = 0; i < deletions.length; i++) {\n      const childToDelete = deletions[i]\n      commitDeletionEffects(root, parentFiber, childToDelete)\n    }\n  }\n  //\u518d\u53bb\u5904\u7406\u5269\u4e0b\u7684\u5b50\u8282\u70b9\n  if (parentFiber.subtreeFlags & MutationMask) {\n    let { child } = parentFiber\n    while (child !== null) {\n      commitMutationEffectsOnFiber(child, root)\n      child = child.sibling\n    }\n  }\n}\n\n//\u5904\u7406\u81ea\u5df1\u8eab\u4e0a\u7684\u526f\u4f5c\u7528\uff0c\u63d2\u5165 \u6216\u8005\u79fb\u52a8\nfunction commitReconciliationEffects(finishedWork) {\n  const { flags } = finishedWork\n  //\u5982\u679c\u6b64fiber\u8981\u6267\u884c\u63d2\u5165\u64cd\u4f5c\u7684\u8bdd\n  if (flags & Placement) {\n    //\u8fdb\u884c\u63d2\u5165\u64cd\u4f5c\uff0c\u4e5f\u5c31\u662f\u628a\u6b64fiber\u5bf9\u5e94\u7684\u771f\u5b9eDOM\u8282\u70b9\u6dfb\u52a0\u5230\u7236\u771f\u5b9eDOM\u8282\u70b9\u4e0a\n    commitPlacement(finishedWork)\n    //\u628aflags\u91cc\u7684Placement\u5220\u9664\n    finishedWork.flags & ~Placement\n  }\n}\n\n/**\n * \u628a\u6b64fiber\u7684\u771f\u5b9eDOM\u63d2\u5165\u5230\u7236DOM\u91cc\n * @param {*} finishedWork\n */\nfunction commitPlacement(finishedWork) {\n  const parentFiber = getHostParentFiber(finishedWork)\n  switch (parentFiber.tag) {\n    case HostRoot: {\n      const parent = parentFiber.stateNode.containerInfo\n      const before = getHostSibling(finishedWork) //\u83b7\u53d6\u6700\u8fd1\u7684\u5f1f\u5f1f\u771f\u5b9eDOM\u8282\u70b9\n      insertOrAppendPlacementNode(finishedWork, before, parent)\n      break\n    }\n    case HostComponent: {\n      const parent = parentFiber.stateNode\n      const before = getHostSibling(finishedWork)\n      insertOrAppendPlacementNode(finishedWork, before, parent)\n      break\n    }\n    default:\n      break\n  }\n}\n")),(0,o.kt)("p",null,"\u603b\u7ed3"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"jsx \u8f6c\u6362\uff0c\u4e0a\u6b21\u865a\u62df dom"),(0,o.kt)("li",{parentName:"ul"},"\u521b\u5efa\u8ddf fiber"),(0,o.kt)("li",{parentName:"ul"},"\u5f00\u542f\u5de5\u4f5c\u5faa\u73af\uff0c\u6267\u884c\u5de5\u4f5c\u5355\u5143 \u6784\u5efa fiber \u6811\uff0c\u7ed9 fiber \u589e\u52a0 flag"),(0,o.kt)("li",{parentName:"ul"},"\u5b8c\u6210\u5de5\u4f5c\u5355\u5143\u7684\u6784\u5efa\uff0c\u521b\u5efa\u771f\u5b9e\u7684 dom\uff0c\u66f4\u65b0\u5c5e\u6027\uff0c\u6b64\u65f6\u6ca1\u6709\u513f\u5b50"),(0,o.kt)("li",{parentName:"ul"},"\u63d0\u4ea4\u9636\u6bb5 \uff0c\u6267\u884c\u526f\u4f5c\u7528\uff0c\u4fee\u6539\u771f\u5b9e DOM")))}u.isMDXComponent=!0}}]);